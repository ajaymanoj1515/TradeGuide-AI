<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediction | TradeGuide AI</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <script src="{{ url_for('static', filename='js/theme.js') }}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        /* Inherit global styles from style.css, adding specific overrides for this page */
        body { height: 100vh; display: flex; overflow: hidden; margin: 0; background-color: var(--bg-body); }
        
        .sidebar { width: 260px; display: flex; flex-direction: column; padding: 25px; backdrop-filter: blur(10px); z-index: 100; border-right: 1px solid var(--border-color); }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        
        /* Sidebar Nav */
        .brand { font-size: 1.4em; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; margin-bottom: 8px; text-decoration: none; border-radius: 8px; transition: 0.3s; font-weight: 500; color: var(--text-muted); }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .nav-item.active { background: rgba(0, 210, 255, 0.1); color: var(--accent); }

        /* Top Bar (Matches Dashboard) */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; position: sticky; top: 0; z-index: 50; background: var(--bg-body); border-bottom: 1px solid var(--border-color); }
        
        /* Prediction Container */
        .dashboard-container { padding: 30px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; height: 100%; display: flex; flex-direction: column; }
        
        /* Search Bar Area */
        .search-area { display: flex; gap: 10px; margin-bottom: 20px; background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); align-items: center; }
        .search-input { padding: 12px; background: var(--bg-body); border: 1px solid var(--border-color); color: var(--text-main); border-radius: 8px; outline: none; font-family: 'Inter'; }
        .btn-analyze { padding: 12px 30px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-analyze:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* Grid Layout */
        .grid-row { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; flex: 1; min-height: 0; }
        
        /* Cards */
        .content-card { background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; }
        
        /* Signal Box */
        .signal-card { text-align: center; padding: 25px; background: #333; color: white; border-radius: 12px; margin-bottom: 20px; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .signal-text { font-size: 2em; font-weight: 800; letter-spacing: 1px; margin: 5px 0; }

        /* Stats */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9em; align-items: center; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--text-muted); }
        .stat-val { font-weight: 600; color: var(--text-main); }

        /* Chart */
        #chartContainer { width: 100%; height: 100%; min-height: 450px; }

        /* Ticker Animation */
        .ticker-wrapper { display: flex; gap: 20px; }
        .ticker-item { font-size: 0.9em; font-weight: 600; color: var(--text-muted); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">
            <i class="fas fa-chart-line" style="color: var(--accent);"></i> &nbsp;TradeGuide<span>AI</span>
        </div>
        
        <div class="nav-links">
            <a href="/dashboard" class="nav-item"><i class="fas fa-home"></i> Dashboard</a>
            <a href="/prediction" class="nav-item active"><i class="fas fa-bolt"></i> Prediction</a>
            <a href="/portfolio" class="nav-item"><i class="fas fa-list"></i> Watchlist</a>
            <a href="/news" class="nav-item"><i class="far fa-newspaper"></i> News Hub</a>
            <a href="/settings" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
        </div>

        <div style="margin-top:auto;">
            <a href="#" id="theme-toggle" class="nav-item">
                <i class="fas fa-moon"></i> Theme
            </a>
            <a href="/logout" class="nav-item" style="color: #ff5252;"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </div>

    <div class="main-content">
        
        <div class="top-bar">
            <div class="ticker-wrapper" id="market-ticker">
                <span class="ticker-item">MARKET STATUS: OPEN</span>
            </div>
            
            <div style="display:flex; align-items:center; gap:15px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-weight: 600; color: var(--text-main);">{{ user.username }}</span>
                    <div style="width:35px; height:35px; background: linear-gradient(135deg, var(--accent), #007bff); border-radius:50%; display:flex; justify-content:center; align-items:center; color: white; font-weight: bold;">
                        {{ user.username[0]|upper }}
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-container">
            
            <div class="search-area">
                <h3 style="margin:0; margin-right:auto; color: var(--accent);"><i class="fas fa-robot"></i> AI ANALYZER</h3>
                
                <input type="text" id="tickerInput" class="search-input" style="width: 200px;" placeholder="Symbol (e.g. TATASTEEL)" value="{{ selected_ticker }}">
                
                <select id="marketSelect" class="search-input">
                    <option value="NSE">NSE (India)</option>
                    <option value="CRYPTO">Crypto</option>
                    <option value="FOREX">Forex</option>
                </select>

                <select id="intervalSelect" class="search-input">
                    <option value="1d">1 Day (Swing)</option>
                    <option value="1wk">1 Week (Positional)</option>
                    <option value="1h">1 Hour (Intraday)</option>
                    <option value="15m">15 Min (Scalp)</option>
                </select>

                <button onclick="analyzeStock()" class="btn-analyze"><i class="fas fa-search"></i> ANALYZE</button>
            </div>

            <div class="grid-row">
                
                <div class="content-card">
                    <h4 id="ticker-title" style="margin-top:0; color:var(--text-muted); font-weight:400;">Ready to analyze...</h4>
                    <div id="chartContainer"></div>
                </div>

                <div class="content-card" style="gap: 20px; overflow-y: auto;">
                    
                    <div class="signal-card">
                        <div style="font-size: 0.8em; opacity: 0.8;">AI VERDICT</div>
                        <div class="signal-text" id="signal-text">--</div>
                        <div id="price" style="font-size: 1.4em;">‚Çπ0.00</div>
                    </div>

                    <div>
                        <h4 style="margin:0 0 10px 0; color: var(--accent); font-size:0.9em; text-transform:uppercase;">üõ°Ô∏è Risk Check</h4>
                        <div class="stat-row">
                            <span class="stat-label">Market State (ADX)</span>
                            <span class="stat-val" id="market-status">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">News Sentiment</span>
                            <span class="stat-val" id="news-sentiment">--</span>
                        </div>
                    </div>

                    <div>
                        <h4 style="margin:0 0 10px 0; color: var(--accent); font-size:0.9em; text-transform:uppercase;">üéØ Key Levels</h4>
                        <div class="stat-row">
                            <span class="stat-label">RSI (14)</span>
                            <span class="stat-val" id="rsi-value">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Golden Pocket</span>
                            <span class="stat-val" id="golden-pocket-value" style="color: #ffd700;">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Stop Loss</span>
                            <span class="stat-val" id="stop-price" style="color: #ff5252;">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Target</span>
                            <span class="stat-val" id="target-price" style="color: #00e676;">--</span>
                        </div>
                    </div>

                    <div style="flex:1;">
                        <h4 style="margin:0 0 10px 0; color: var(--accent); font-size:0.9em; text-transform:uppercase;">ü§ñ Logic</h4>
                        <ul id="reasons-list" style="padding-left: 20px; margin: 0; font-size: 0.85em; color: var(--text-muted); line-height: 1.5;">
                            <li>Waiting for analysis...</li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Auto-Run on Load
        window.onload = function() {
            const urlTicker = document.getElementById('tickerInput').value;
            if(urlTicker) analyzeStock();
            
            // Auto update ticker (Optional)
            updateTicker(); 
        };

        // 2. Analyze Function
        function analyzeStock() {
            const ticker = document.getElementById('tickerInput').value;
            const market = document.getElementById('marketSelect').value;
            const interval = document.getElementById('intervalSelect').value;

            if(!ticker) return alert("Please enter a ticker!");

            // UI Feedback
            document.getElementById('ticker-title').innerText = `Analyzing ${ticker}...`;
            document.getElementById('signal-text').innerText = "LOADING...";
            document.querySelector('.signal-card').style.background = "#333";

            fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker, market, interval })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) updateUI(data.data);
                else {
                    alert("Error: " + data.error);
                    document.getElementById('signal-text').innerText = "ERROR";
                }
            })
            .catch(err => console.error(err));
        }

        // 3. Update UI Function
        function updateUI(data) {
            console.log("Data:", data);

            // Basic Info
            document.getElementById('ticker-title').innerText = `${data.ticker} Analysis [${document.getElementById('intervalSelect').value}]`;
            document.getElementById('price').innerText = data.current_price;
            document.getElementById('signal-text').innerText = data.signal;

            // Signal Color
            const card = document.querySelector('.signal-card');
            if(data.signal.includes("BUY")) card.style.background = "linear-gradient(135deg, #00e676, #00b34d)";
            else if(data.signal.includes("SELL")) card.style.background = "linear-gradient(135deg, #ff5252, #d50000)";
            else card.style.background = "#555";

            // High Level Metrics
            document.getElementById('market-status').innerText = data.market_status;
            document.getElementById('news-sentiment').innerText = data.news_sentiment;

            // Key Levels
            document.getElementById('rsi-value').innerText = data.rsi ? data.rsi : "--";
            document.getElementById('golden-pocket-value').innerText = data.golden_pocket ? data.golden_pocket : "--";
            
            if(data.levels) {
                document.getElementById('stop-price').innerText = data.levels.stoploss;
                document.getElementById('target-price').innerText = data.levels.target;
            }

            // Reasons
            const list = document.getElementById('reasons-list');
            list.innerHTML = "";
            if(data.reasons && data.reasons.length > 0) {
                data.reasons.forEach(r => {
                    let li = document.createElement("li");
                    li.innerText = r;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = "<li>No specific triggers found.</li>";
            }

            renderChart(data.chart_data);
        }

        // 4. Render Chart (ApexCharts)
        function renderChart(data) {
            var options = {
                series: [{ data: data }],
                chart: {
                    type: 'candlestick',
                    height: '100%',
                    background: 'transparent',
                    toolbar: { show: false }
                },
                theme: { mode: 'dark' }, // Matches dark theme by default
                xaxis: { type: 'datetime', labels: { style: { colors: '#94a3b8' } } },
                yaxis: { tooltip: { enabled: true }, labels: { style: { colors: '#94a3b8' } } },
                grid: { borderColor: '#334155' },
                plotOptions: {
                    candlestick: { colors: { upward: '#00e676', downward: '#ff5252' } }
                }
            };

            const container = document.querySelector("#chartContainer");
            container.innerHTML = ""; 
            new ApexCharts(container, options).render();
        }

        // 5. Mini Ticker Logic (Optional placeholder)
        async function updateTicker() {
             // You can connect this to your existing ticker API if you have one
             // For now, it stays static or you can add the logic from dashboard.html here
        }
    </script>
</body>
</html>